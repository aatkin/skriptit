(ns skriptit.rems
  (:require [babashka.process :refer [shell]]
            [clojure.string :as str]
            [skriptit.cli :refer [lein-dep print-cmd wrap-vec]]))

;; code generated by ChatGPT v3.5. incredible times
(defn rems-tag [cli-args]
  (let [changelog (slurp "CHANGELOG.md")
        release-version (second (re-find #"## v([\d.]+)" changelog))
        release-name (second (re-find #"## v[\d.]+ \"([^\"]+)\"" changelog))
        tag-command (str "git tag -a " release-version
                         " -m \"Release " release-version
                         ", \\\"" release-name "\\\"\"")]
    (println tag-command)))

;; start postgres:13 container with existing volume for rems-dev local database
(defn rems-db [cli-args]
  (let [volume (or (first cli-args)
                   (System/getenv "REMS_DB_DOCKER_VOLUME"))]
    (assert (not (str/blank? volume)) "volume cannot be empty")
    (shell print-cmd
           "docker run"
           "--rm"
           "--name" "rems_test"
           "-v" (str volume ":/var/lib/postgresql/data")
           "-p" "127.0.0.1:5432:5432"
           "-d"
           "-e" "POSTGRES_HOST_AUTH_METHOD=trust"
           "postgres:13")))

;; :doc "start REMS in development mode with headless nREPL (mostly same startup code as Calva uses)"
;; XXX: this could be generic leiningen script to add nREPL dependencies?
;; XXX: something wrong with shadow-cljs and leiningen, does not work correctly
;; deps-shadow ["update-in" ":dependencies" "conj" (lein-dep "thheller/shadow-cljs" "2.19.0")]
;; repl-shadow ["update-in" "[:repl-options :nrepl-middleware]" "conj" (lein-dep "shadow.cljs.devtools.server.nrepl/middleware")]
(defn rems-dev [cli-args]
  (let [deps-nrepl ["update-in" :dependencies
                    "conj" (lein-dep "nrepl" "1.0.0")]
        plugins ["update-in" :plugins
                 "conj" (lein-dep "cider/cider-nrepl" "0.28.5")]
        repl-cider ["update-in" (wrap-vec :repl-options :nrepl-middleware)
                    "conj" (lein-dep "cider.nrepl/cider-middleware")]
        profiles "+dev,+portal,+snitch"
        cmd ["trampoline" "with-profile" profiles "repl" :headless]]
    (apply shell print-cmd "lein" (->> (list deps-nrepl plugins repl-cider cmd)
                                       (interpose ["--"])
                                       (flatten)))))

(defn rems-shadow [cli-args]
  (let [repl-options ["-d" "cider/cider-nrepl:0.28.5"]
        cmd ["npx" "shadow-cljs" repl-options "watch" ":app"]]
    (apply shell print-cmd (flatten cmd))))

;; :doc "\"rems-test [target]\"
;; run kaocha in watch + fail fast modes, specify target for specific tests, special handling for \"integration\" and \"browser\""
(defn rems-test [cli-args]
  (let [target (first cli-args)
        cmd ["trampoline" "kaocha"]
        opts ["--watch"
              "--fail-fast"
              (if (some #{"integration" "browser"} [target])
                ["--reporter" "kaocha.report/documentation" target]
                ["--focus" target])]]
    (apply shell print-cmd "lein" (->> (list cmd opts)
                                       (flatten)))))
